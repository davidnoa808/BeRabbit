<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>üéß DJ Playlist </title>
  <style>
    body{margin:0;padding:20px;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;max-width:480px;margin:auto}
    .container{padding:20px}.app-title{text-align:center;font-size:2.5em;font-weight:bold;margin-bottom:30px}
    .search-container{background:#1a1a1a;padding:20px;border-radius:10px;margin:20px 0}
    .search-input{width:100%;padding:15px;border:none;border-radius:25px;background:#333;color:#fff;font-size:1.1em;margin-bottom:20px;box-sizing:border-box}
    .search-results{margin-top:20px}
    .result-item{background:#333;padding:15px;margin:10px 0;border-radius:5px;display:flex;align-items:center;position:relative}
    .result-thumbnail{width:120px;height:90px;border-radius:5px;margin-right:15px;object-fit:cover}
    .duration-badge{position:absolute;bottom:5px;right:5px;background:rgba(0,0,0,.7);color:#fff;padding:2px 6px;border-radius:4px;font-size:.7em}
    .result-info{flex-grow:1}
    .result-title{font-weight:bold;margin-bottom:5px}
    .button-container{display:flex;gap:10px;margin-top:10px}
    .button{padding:10px 15px;border:none;border-radius:5px;cursor:pointer;font-size:.9em;transition:opacity .3s}
    .button-save{background:#ff0000;color:#fff}
    .button-replay{background:#00cc00;color:#fff}
    .button-list{background:#0066cc;color:#fff;width:100%;margin-top:20px}
    .button-clear{background:#cc0000;color:#fff;width:100%}
    .button-stats{background:#9C27B0;color:#fff;width:100%;margin-top:10px}
    .button:hover{opacity:.9}
    #modalNext{background:rgba(0,0,0,.9);position:fixed;top:0;left:0;width:100%;height:100%;z-index:2000;display:none;justify-content:center;align-items:center;flex-direction:column}
    #modalNext div{background:#1a1a1a;padding:2rem;border-radius:10px;text-align:center}
    #modalNext button{margin-top:1rem;background:#0066cc;color:#fff;padding:.5rem 1rem;border:none;border-radius:5px;cursor:pointer}

    /* Modal de la playlist */
    #modalPlaylist{
      position:fixed; inset:0;
      background:rgba(0,0,0,.85);
      color:#fff; display:none;
      align-items:center; justify-content:center;
      z-index:3000;
    }
    #modalPlaylistBox{
      background:#1a1a1a; max-width:480px;
      width:90%; max-height:80vh;
      overflow-y:auto; padding:20px;
      border-radius:10px;
    }
    .playlist-item{
      display:flex; align-items:center;
      background:#333; margin-bottom:10px;
      padding:10px; border-radius:5px;
      position:relative;
    }
    .playlist-thumb{
      width:120px; height:90px;
      border-radius:5px; margin-right:10px;
    }
    .playlist-title{flex-grow:1}
    .playlist-duration{margin-right:15px}
    .remove-btn{
      position:absolute; top:5px; right:5px;
      background:#ff0000; color:#fff;
      border:none; border-radius:50%;
      width:25px; height:25px;
      cursor:pointer; font-weight:bold;
    }
    .modal-buttons{
      display:flex; gap:10px; margin-top:20px;
    }
    .modal-buttons button{
      flex:1; padding:12px; border:none;
      border-radius:5px; cursor:pointer;
      font-size:1em;
    }
    #sendToDbBtn{background:#0066cc; color:#fff}
    #closeModalBtn{background:#666; color:#fff}
    
    /* Modales de estad√≠sticas y login */
    .stats-modal, .login-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 4000;
    }
    
    .stats-content, .login-content {
      background: #1a1a1a;
      padding: 25px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .login-content {
      max-width: 400px;
    }
    
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 0.9em;
    }
    
    .stats-table th, .stats-table td {
      border: 1px solid #444;
      padding: 8px;
      text-align: left;
    }
    
    .stats-table th {
      background: #333;
    }
    
    .stats-summary {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    
    .login-input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      background: #333;
      border: 1px solid #444;
      border-radius: 5px;
      color: white;
      box-sizing: border-box;
    }
    
    .login-btn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }
    
    .stats-close, .login-close {
      float: right;
      font-size: 24px;
      cursor: pointer;
      color: #aaa;
    }
    
    .stats-close:hover, .login-close:hover {
      color: white;
    }
    
    .stats-section {
      margin: 20px 0;
    }
    
    .stats-section h3 {
      border-bottom: 1px solid #444;
      padding-bottom: 8px;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="app-title">üéß DJ Playlist</div>
    <div class="search-container">
      <input id="searchInput" class="search-input" placeholder="Buscar canciones..."/>
      <div id="searchResults"></div>
      <button id="playPlaylistButton" class="button button-list" onclick="playPlaylist()" style="display:none">Reproducir Lista</button>
      <button id="sendPlaylistButton" class="button button-list" onclick="sendPlaylist()" style="display:none">Lista</button>
      <button id="clearPlaylistButton" class="button button-clear" onclick="clearPlaylist()" style="display:none">Borrar Lista</button>
      <button id="statsButton" class="button button-stats" onclick="showLoginModal()">Estad√≠sticas</button>
    </div>
  </div>

  <!-- Modal de la playlist -->
  <div id="modalPlaylist">
    <div id="modalPlaylistBox">
      <h2 style="text-align:center;margin-bottom:15px;">Mi Playlist</h2>
      <div id="playlistDisplay"></div>
      <div class="modal-buttons">
        <button id="sendToDbBtn">Envia Lista</button>
        <button id="closeModalBtn">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="modalNext">
    <div>
      <h2 id="nextTitle">Canci√≥n terminada</h2>
      <p id="nextText">Siguiente canci√≥n en 3 s‚Ä¶</p>
      <button id="skipBtn">Saltar</button>
    </div>
  </div>

  <!-- Modal de Login para Estad√≠sticas -->
  <div id="loginModal" class="login-modal">
    <div class="login-content">
      <span class="login-close" id="closeLoginModal">&times;</span>
      <h2 style="text-align:center;margin-bottom:20px;">Acceso a Estad√≠sticas</h2>
      <form id="loginForm">
        <input type="text" id="username" class="login-input" placeholder="Usuario" required>
        <input type="password" id="password" class="login-input" placeholder="Contrase√±a" required>
        <button type="submit" class="login-btn">Entrar</button>
      </form>
      <div id="loginMessage" style="color:#ff4444;text-align:center;margin-top:15px;display:none;"></div>
    </div>
  </div>

  <!-- Modal de Estad√≠sticas -->
  <div id="statsModal" class="stats-modal">
    <div class="stats-content">
      <span class="stats-close" id="closeStatsModal">&times;</span>
      <h2 style="text-align:center;margin-bottom:20px;">Estad√≠sticas de Pagos</h2>
      
      <!-- Resumen General -->
      <div class="stats-summary">
        <h3>Resumen General</h3>
        <div style="display: flex; justify-content: space-between;">
          <div>
            <p><strong>Total Recaudado:</strong> <span id="totalRevenue">$0</span></p>
            <p><strong>Total Canciones:</strong> <span id="totalSongs">0</span></p>
          </div>
          <div>
            <p><strong>Pagos Realizados:</strong> <span id="totalPayments">0</span></p>
            <p><strong>Nequi:</strong> 3127439018</p>
          </div>
        </div>
      </div>

      <!-- Tabla de Pagos Detallados -->
      <div class="stats-section">
        <h3>Pagos Detallados</h3>
        <div style="overflow-x:auto;">
          <table class="stats-table" id="paymentsTable">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>C√≥digo</th>
                <th>Monto</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody">
              <!-- Los datos se cargar√°n din√°micamente -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tabla Resumen de Canciones -->
      <div class="stats-section">
        <h3>Resumen de Canciones Pagadas</h3>
        <div style="overflow-x:auto;">
          <table class="stats-table" id="songsTable">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Canciones Pagadas</th>
                <th>Total Pagado</th>
              </tr>
            </thead>
            <tbody id="songsTableBody">
              <!-- Los datos se cargar√°n din√°micamente -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Botones de acci√≥n -->
      <div style="text-align:center;margin-top:20px;">
        <button class="button" id="refreshStats" style="background:#2196F3;width:48%;">
          Actualizar
        </button>
        <button class="button" id="closeStats" style="background:#666;width:48%;">
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <script>
/********************************************************************/
/* CONFIG ‚Äì 7 rotating keys                                         */
/********************************************************************/
const API_KEYS = [
  'AIzaSyBvB66C8XumtHi2E2Akarke6lB6u45vsWs',
  'AIzaSyC85KOeXSjVTvyZYM54nh0PtBZ6qkwD1pw',
  'AIzaSyDmBDPfVFzNGzcfKamOspWszCwbfxR0oso',
  'AIzaSyB6OrwXB7s2uknIKeLHo-nsvPOzA2jKtJU',
  'AIzaSyBPbFDpwb-j3AUp9Q_BbuYB808nMYKI93g',
  'AIzaSyBKuNLzOrg1HhgHEdjmA0MCEkqj0z_065c',
  'AIzaSyDtc1YV63E7wNyUtmEO8YlqA0kRdtw-7-E'
];
let keyIndex = 0;

/********************************************************************/
/* DOM SHORTCUTS                                                    */
/********************************************************************/
const $ = id => document.getElementById(id);
const searchInput  = $('searchInput');
const searchResults= $('searchResults');
const modalNext    = $('modalNext');
const nextTitle    = $('nextTitle');
const nextText     = $('nextText');
const playBtn      = $('playPlaylistButton');
const sendBtn      = $('sendPlaylistButton');
const clearBtn     = $('clearPlaylistButton');
const skipBtn      = $('skipBtn');
const statsBtn     = $('statsButton');

/********************************************************************/
/* STATE                                                            */
/********************************************************************/
let playlist   = [];
let currentIdx = 0;
let totalPlayed= 0;

// Datos de pagos (en un caso real, esto vendr√≠a de una base de datos)
let paymentsData = JSON.parse(localStorage.getItem('paymentsData') || '[]');

/********************************************************************/
/* STORAGE ‚Äì persiste en localStorage                               */
/********************************************************************/
const loadPlaylist = () => {
  const saved = localStorage.getItem('playlist');
  playlist = saved ? JSON.parse(saved) : [];
  [playBtn, sendBtn, clearBtn].forEach(b => b.style.display = playlist.length ? 'block' : 'none');
};
const savePlaylist = () => localStorage.setItem('playlist', JSON.stringify(playlist));

// Guardar datos de pagos
const savePaymentsData = () => {
  localStorage.setItem('paymentsData', JSON.stringify(paymentsData));
};

/********************************************************************/
/* SISTEMA DE ESTAD√çSTICAS Y LOGIN                                  */
/********************************************************************/

// Mostrar modal de login
function showLoginModal() {
  $('loginModal').style.display = 'flex';
  $('username').value = '';
  $('password').value = '';
  $('loginMessage').style.display = 'none';
}

// Ocultar modal de login
function hideLoginModal() {
  $('loginModal').style.display = 'none';
}

// Mostrar modal de estad√≠sticas
function showStatsModal() {
  $('statsModal').style.display = 'flex';
  loadStatistics();
}

// Ocultar modal de estad√≠sticas
function hideStatsModal() {
  $('statsModal').style.display = 'none';
}

// Manejar login
function handleLogin(e) {
  e.preventDefault();
  
  const username = $('username').value;
  const password = $('password').value;
  
  // Credenciales hardcodeadas (en producci√≥n, esto deber√≠a venir de un servidor)
  const validUsername = 'admin';
  const validPassword = 'admin123';
  
  if (username === validUsername && password === validPassword) {
    hideLoginModal();
    showStatsModal();
  } else {
    $('loginMessage').textContent = 'Usuario o contrase√±a incorrectos';
    $('loginMessage').style.display = 'block';
  }
}

// Cargar estad√≠sticas
function loadStatistics() {
  // Calcular resumen
  const totalRevenue = paymentsData.reduce((sum, payment) => sum + payment.amount, 0);
  const totalSongs = paymentsData.reduce((sum, payment) => sum + payment.songsCount, 0);
  const totalPayments = paymentsData.length;
  
  // Actualizar resumen
  $('totalRevenue').textContent = `$${totalRevenue.toLocaleString()}`;
  $('totalSongs').textContent = totalSongs;
  $('totalPayments').textContent = totalPayments;
  
  // Actualizar tabla de pagos detallados
  const paymentsTableBody = $('paymentsTableBody');
  paymentsTableBody.innerHTML = '';
  
  paymentsData.forEach(payment => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${payment.user}</td>
      <td>${payment.id}</td>
      <td>$${payment.amount.toLocaleString()}</td>
      <td>${new Date(payment.date).toLocaleDateString()}</td>
    `;
    paymentsTableBody.appendChild(row);
  });
  
  // Actualizar tabla de resumen de canciones
  updateSongsTable();
}

// Actualizar tabla de canciones
function updateSongsTable() {
  const songsTableBody = $('songsTableBody');
  songsTableBody.innerHTML = '';
  
  // Agrupar por usuario
  const userStats = {};
  
  paymentsData.forEach(payment => {
    if (!userStats[payment.user]) {
      userStats[payment.user] = {
        songsCount: 0,
        totalAmount: 0
      };
    }
    
    userStats[payment.user].songsCount += payment.songsCount;
    userStats[payment.user].totalAmount += payment.amount;
  });
  
  // Crear filas para cada usuario
  Object.entries(userStats).forEach(([user, stats]) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${user}</td>
      <td>${stats.songsCount}</td>
      <td>$${stats.totalAmount.toLocaleString()}</td>
    `;
    songsTableBody.appendChild(row);
  });
}

// Funci√≥n para agregar un pago de ejemplo (para pruebas)
function addSamplePayment() {
  const samplePayment = {
    id: 'PAY_' + Date.now(),
    user: 'Usuario Ejemplo',
    amount: 80000,
    songsCount: 10,
    date: new Date().toISOString()
  };
  
  paymentsData.push(samplePayment);
  savePaymentsData();
  loadStatistics();
}

/********************************************************************/
/* EVENT LISTENERS PARA ESTAD√çSTICAS                                */
/********************************************************************/

// Configurar event listeners cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
  // Login form
  $('loginForm').addEventListener('submit', handleLogin);
  
  // Cerrar modales
  $('closeLoginModal').addEventListener('click', hideLoginModal);
  $('closeStatsModal').addEventListener('click', hideStatsModal);
  $('closeStats').addEventListener('click', hideStatsModal);
  
  // Actualizar estad√≠sticas
  $('refreshStats').addEventListener('click', loadStatistics);
  
  // Cerrar modales al hacer clic fuera
  window.addEventListener('click', function(e) {
    if (e.target === $('loginModal')) hideLoginModal();
    if (e.target === $('statsModal')) hideStatsModal();
  });
});

/********************************************************************/
/* SEARCH WITH 7-KEY ROTATION + DURACI√ìN EN MINIATURA               */
/********************************************************************/
searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim();
  q ? searchSongs(q) : (searchResults.innerHTML = '');
});

async function searchSongs(query, attempt = 0) {
  if (attempt >= API_KEYS.length) {
    alert('Todas las claves API est√°n bloqueadas o con error.');
    return;
  }
  const key = API_KEYS[keyIndex];
  const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=50&type=video&q=${encodeURIComponent(query)}&key=${key}`;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('Key fail');
    const data = await res.json();
    // fetch duration for each result
    const ids = data.items.map(i => i.id.videoId).join(',');
    const detailUrl = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${ids}&key=${key}`;
    const detailRes = await fetch(detailUrl);
    const detailData = await detailRes.json();
    data.items.forEach((item, idx) => {
      const dur = detailData.items[idx]?.contentDetails?.duration || 'PT0S';
      item.duration = parseISO8601(dur);
    });
    displayResults(data.items);
  } catch {
    keyIndex = (keyIndex + 1) % API_KEYS.length;
    searchSongs(query, attempt + 1);
  }
}

function displayResults(items) {
  searchResults.innerHTML = items.map(it => {
    const mm = Math.floor(it.duration / 60000);
    const ss = String(Math.floor(it.duration / 1000) % 60).padStart(2, '0');
    return `
      <div class="result-item">
        <img class="result-thumbnail" src="${it.snippet.thumbnails.medium.url}" />
        <span class="duration-badge">${mm}:${ss}</span>
        <div class="result-info">
          <div class="result-title">${it.snippet.title}</div>
          <div class="button-container">
            <button class="button button-save" onclick="addToPlaylist('${it.id.videoId}','${it.snippet.title.replace(/'/g,"\\'")}')">Guardar</button>
            <button class="button button-replay" onclick="playSingle('${it.id.videoId}')">Reproducir</button>
          </div>
        </div>
      </div>`;
  }).join('');
  [playBtn, sendBtn, clearBtn].forEach(b => b.style.display = playlist.length ? 'block' : 'none');
}

function addToPlaylist(id, title) {
  playlist.push({ videoId: id, title });
  savePlaylist();
  [playBtn, sendBtn, clearBtn].forEach(b => b.style.display = 'block');
}

/********************************************************************/
/* DETECT OFFICIAL + UNAVAILABLE + DURATION                         */
/********************************************************************/
function parseISO8601(str) {
  const match = str.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
  return (parseInt(match[1] || 0, 10) * 3600 +
          parseInt(match[2] || 0, 10) * 60 +
          parseInt(match[3] || 0, 10)) * 1000;
}

/********************************************************************/
/* PLAY SINGLE                                                      */
/********************************************************************/
async function playSingle(id) {
  const dur = await getVideoDetails(id);
  openBrowser(`https://www.youtube.com/watch?v=${id}`, dur);
}

async function getVideoDetails(id) {
  const key = API_KEYS[keyIndex];
  try {
    const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${id}&key=${key}`);
    const data = await res.json();
    const dur = data.items[0]?.contentDetails?.duration || 'PT0S';
    return parseISO8601(dur);
  } catch {
    return 0;
  }
}

/********************************************************************/
/* PLAYLIST ‚Äì sin interrupci√≥n                                      */
/********************************************************************/
async function playPlaylist() {
  if (!playlist.length) { alert('Lista vac√≠a'); return; }
  currentIdx = 0;
  totalPlayed = 0;
  playNextInPlaylist();
}

async function playNextInPlaylist() {
  if (currentIdx >= playlist.length) {
    finishPlaylist();
    return;
  }
  const { videoId, title } = playlist[currentIdx];
  const dur = await getVideoDetails(videoId);
  openBrowser(`https://www.youtube.com/watch?v=${videoId}`, dur, () => {
    currentIdx++;
    totalPlayed++;
    showNextModal(title);
  });
}

/********************************************************************/
/* EXTERNAL BROWSER ‚Äì auto-close after duration                     */
/********************************************************************/
function openBrowser(url, durationMs, onClose = () => {}) {
  const win = window.open(url, '_blank', 'noopener,noreferrer');
  const timer = setInterval(() => {
    if (win && win.closed) { clearInterval(timer); onClose(); }
  }, 1000);
  setTimeout(() => { if (win) win.close(); onClose(); }, durationMs);
}

/********************************************************************/
/* NEXT / FINISH MODAL                                              */
/********************************************************************/
function showNextModal(title) {
  nextTitle.textContent = title;
  nextText.textContent  = 'Siguiente canci√≥n en 3 s‚Ä¶';
  skipBtn.onclick = () => {
    modalNext.style.display = 'none';
    playNextInPlaylist();
  };
  modalNext.style.display = 'flex';
  setTimeout(() => {
    if (modalNext.style.display !== 'none') {
      modalNext.style.display = 'none';
      playNextInPlaylist();
    }
  }, 3000);
}

function finishPlaylist() {
  nextTitle.textContent = 'Lista terminada';
  nextText.textContent  = `${totalPlayed} canciones reproducidas`;
  skipBtn.onclick = () => {
    modalNext.style.display = 'none';
  };
  modalNext.style.display = 'flex';
}

/********************************************************************/
/* BORRAR LISTA                                                     */
/********************************************************************/
function clearPlaylist() {
  playlist.length = 0;
  localStorage.removeItem('playlist');
  [playBtn, sendBtn, clearBtn].forEach(b => b.style.display = 'none');
  searchResults.innerHTML = '';
  alert('Lista borrada con √©xito.');
}

/********************************************************************/
/* MODAL PLAYLIST                                                   */
/********************************************************************/
function sendPlaylist() {
  if (!playlist.length) { alert('No hay nada que enviar'); return; }
  showPlaylistModal();
}

function showPlaylistModal() {
  const box = $('playlistDisplay');
  if (!playlist.length) { box.innerHTML='<p>Lista vac√≠a</p>'; }
  else {
    box.innerHTML = playlist.map((it, idx) => `
      <div class="playlist-item">
        <img class="playlist-thumb" src="https://i.ytimg.com/vi/${it.videoId}/mqdefault.jpg">
        <div>
          <div class="playlist-title">${it.title}</div>
          <div class="playlist-duration">Duraci√≥n: --:--</div>
        </div>
        <button class="remove-btn" onclick="removeFromPlaylist(${idx})">√ó</button>
      </div>`).join('');
  }
  $('modalPlaylist').style.display='flex';
}

function closePlaylistModal() {
  $('modalPlaylist').style.display='none';
}

function removeFromPlaylist(index) {
  playlist.splice(index,1);
  savePlaylist();
  [playBtn, sendBtn, clearBtn].forEach(b => b.style.display = playlist.length ? 'block' : 'none');
  showPlaylistModal();
}

async function pushPlaylistToDB() {
  if (!playlist.length) return;
  const payload = { playlist };
  try {
    const res = await fetch('save_playlist.php', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const txt = await res.text();
    alert(txt || '¬°Lista guardada en la BD!');
  } catch(e) {
    alert('Error al conectar con el servidor');
  }
}

$('sendToDbBtn').addEventListener('click', pushPlaylistToDB);
$('closeModalBtn').addEventListener('click', closePlaylistModal);

// Inicializar la aplicaci√≥n
loadPlaylist();

// Para pruebas: descomenta la siguiente l√≠nea para agregar un pago de ejemplo
// addSamplePayment();
  </script>
</body>
</html>
